# Документация базы данных системы анализа отзывов

## Обзор схемы

База данных спроектирована для поддержки всех use-cases системы анализа отзывов с маркетплейсов.

## Таблицы и назначение

### 1. users - Пользователи системы
**Назначение:** Хранение данных зарегистрированных пользователей
**Ключевые поля:**
- `email_verified` - подтверждение email для доступа к функционалу
- `verification_token` - токен для верификации email
- `last_login_at` - отслеживание активности

### 2. projects - Проекты анализа
**Назначение:** Хранение информации об анализах товаров
**Ключевые поля:**
- `marketplace_type` - ограниченный список поддерживаемых маркетплейсов
- `status` - отслеживание прогресса анализа
- `total_reviews` - кэширование количества отзывов

### 3. reviews - Отзывы товаров
**Назначение:** Хранение сырых отзывов и результатов первичного анализа
**Ключевые поля:**
- `sentiment` - тональность отзыва (positive/negative/neutral)
- `aspects_json` - извлеченные аспекты в JSON формате
- `helpful_count` - количество "полезно" для ранжирования

### 4. analysis_results - Результаты анализа
**Назначение:** Агрегированные результаты для построения отчетов
**Ключевые поля:**
- `summary_json` - сводная статистика
- `charts_data` - данные для построения графиков
- `aspects_analysis` - анализ по аспектам товара
- `top_reviews` - самые полезные отзывы

### 5. llm_interactions - Взаимодействия с AI
**Назначение:** Логирование всех запросов к LLM для отладки и анализа
**Ключевые поля:**
- `prompt_type` - тип промпта для категоризации
- `tokens_used` - мониторинг стоимости запросов
- `processing_time_ms` - отслеживание производительности

### 6. user_sessions - Сессии пользователей
**Назначение:** Управление аутентификацией и сессиями
**Ключевые поля:**
- `token_hash` - хэш JWT токена
- `expires_at` - время истечения сессии

## Оптимизации производительности

### Критические индексы:
1. **idx_projects_user_created** - быстрый доступ к истории анализов пользователя
2. **idx_reviews_project_sentiment** - фильтрация отзывов по тональности
3. **idx_llm_project_type** - анализ использования LLM по проектам

### Стратегии хранения:
- **JSONB** для гибких данных (аспекты, графики)
- **Частичные индексы** для активных данных
- **Каскадное удаление** для целостности

## Миграции и версионирование

### Рекомендуемые миграции:
```sql
-- Добавление новых маркетплейсов
ALTER TABLE projects 
ADD CONSTRAINT valid_marketplace 
CHECK (marketplace_type IN ('wildberries', 'ozon', 'yandex_market', 'new_marketplace'));

-- Добавление квот пользователей
ALTER TABLE users ADD COLUMN monthly_quota INTEGER DEFAULT 50;
